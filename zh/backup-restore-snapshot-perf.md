---
title: 基于 EBS 卷快照备份恢复的性能介绍
summary: 了解 EBS 卷快照备份恢复的性能基线。
---

# EBS 卷快照备份的性能

本节介绍影响备份性能的因素以及性能测试结果。以下测试指标基于 AWS region：us-west-2。

## EBS 卷快照备份各阶段的耗时

EBS 卷快照备份阶段包含创建备份任务，停止调度，停止 GC，获取备份时间 backupts 以及 卷快照。详细见 [基于 EBS 卷快照的备份恢复功能架构](backup-restore-overview.md)。其中最耗时的部分是创建卷快照。备份过程中卷的快照创建是并行的，一个备份完成时间取决于用时最后一个卷的快照完成时间。

### 备份各阶段耗时总占比

| 恢复阶段     | 恢复大致耗时 | 恢复总占比 | 备注                                     |
| :--------: | :---------: | :------: | :-------------------------------------: |
| 卷快照时间   | 16 m (50GB) | %99      | AWS EBS snapshot 的时间                  |
| 其他        | 1s          | %1       | 包含停止调度，停止 GC，获取备份时间 backupts |

## EBS 卷快照备份的性能

卷快照备份时间取决于最后一个数据卷快照完成时间，这部分工作由 AWS EBS 服务来完成，当前 AWS 并没有提供卷快照完成量化指标。根据我们的测试，在 TiDB-Operator 推荐配置下 （GP3）整个备份时间大致如下：

![EBS Snapshot backup perf](/media/volume-snapshot-backup-perf.png)

| 单卷数据  | 卷大小   | 卷配置         | 备份大致耗时 |
| :------: | :-----: | :-----------: | :--------: |
| 50 GB    | 500 GB  | 400MB/7000IOPS | 20 min    |
| 100 GB   | 500 GB  | 400MB/7000IOPS | 50 min    |
| 200 GB   | 500 GB  | 400MB/7000IOPS | 100 min   |
| 500 GB   | 1024 GB | 400MB/7000IOPS | 150 min   |
| 1024 GB  | 3500 GB | 400MB/7000IOPS | 350 min   |

> **注意：**
>
> 上述性能数据是基于全量数据备份而进行的备份。
>
> 因为 AWS 卷快照是以卷为单位，除第一个卷快照是全量，后续卷快照都是以增量的形式进行。每日备份一般情况下可以在 1 小时完成，如遇特殊情况，可缩短备份频率，如 12 小时 或者 8 小时备份一次。
>

## EBS 卷快照备份影响

因 AWS EBS 卷快照特点，使用 GP3 卷进行备份时，经过测试集群影响小于 3%。如下图所示，10:25 分之后发起备份。

![EBS Snapshot backup impact](/media/volume-snapshot-backup-impact.jpg)

# EBS 卷快照恢复的性能

本节介绍影响恢复性能的因素以及性能测试结果。

## EBS 卷快照恢复各阶段的耗时

EBS 卷快照恢复阶段包含以下阶段，详细见 [基于 EBS 卷快照的备份恢复功能架构](backup-restore-overview.md)

1. 创建集群阶段

TiDB Operator 创建 recoveryMode 的待恢复集群，启动所有 PD 节点。

2. 卷恢复阶段

TiDB Operator 创建 BR 卷恢复子任务，BR 从卷快照中恢复出 TiKV 启动需要的数据卷。

3. 启动 TiKV 阶段

TiDB Operator 挂载 TiKV 卷，启动 TiKV。

4. 数据恢复阶段

TiDB Operator 创建 TiKV 卷数据恢复子任务，BR 把所以 TiKV 数据卷恢复到一致性状态。

5. 启动 TiDB：启动 TiDB，恢复完成

### 各阶段耗时总占比

| 恢复阶段     | 恢复大致耗时 | 恢复总占比 | 备注                                                            |
| :--------: | :---------: | :------: | :-------------------------------------------------------------: |
| 创建集群     | 30s         | %1       | 包含下载 docker image 和启动 pd                                   |
| 卷恢复      | 20s         | %1       | 包含启动 br pod 和卷恢复                                           |
| TiKV 启动   | 2～30min    | 58%      | 备份时有正在进行的事务，此备份做恢复时，rocksdb 启动产生额外耗时 5～30min |
| 数据恢复阶段 | 2～20min    | 38%       | 包含raft 共识层数据恢复以及 MVCC 删除数据操作                        |
| 启动 TiDB   | 1min        | 2%       | 包含下载 tidb docker image， 和启动 tidb                          |

> **注意：**
>
> 因为卷快照是 crash consistency 的状态，EBS 卷快照恢复阶段 TiKV 启动阶段， 需要先启动 kv db (rocksdb), 此阶段在有写入的备份恢复中，会产生额外的耗时。经测试，额外的耗时在 30 分钟以内，如使用高性能盘恢复，如 io2, 额外耗时可缩短到 5 分钟内，如果使用标准 GP3 盘 （3000IOPS/125MBps），额外耗时可能到达到 30 分钟左右。
>

## EBS 卷快照恢复阶段的性能

卷快照恢复时间取主要决于 TiKV 启动和数据恢复阶段，TiKV 启动受 EBS 卷快照恢复延迟初始化影响，启动时间在2分钟到30分钟之间，这部分工作由 AWS EBS 服务来完成，当前 AWS 并没有提供卷快照完成量化指标。根据我们的测试，在 TiDB-Operator 推荐 EC2 机型配置下 使用 GP3 整个恢复时间大致如下：

![EBS Snapshot restore perf](/media/volume-snapshot-restore-perf.png)

| 单卷数据  | 卷大小   | 卷配置         | 恢复大致耗时 |
| :------: | :-----: | :-----------: | :--------: |
| 50 GB    | 500 GB  | 400MB/7000IOPS | 16 min    |
| 100 GB   | 500 GB  | 400MB/7000IOPS | 18 min    |
| 200 GB   | 500 GB  | 400MB/7000IOPS | 21 min   |
| 500 GB   | 1024 GB | 400MB/7000IOPS | 25 min   |
| 1024 GB  | 3500 GB | 400MB/7000IOPS | 34 min   |

> **注意：**
>
> 此性能测试结果仅供查考，实际情况会有些差别。
>
